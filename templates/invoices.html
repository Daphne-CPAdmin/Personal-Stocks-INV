{% extends "base.html" %}

{% block title %}Invoices - Deej - Inventory Manager{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Invoice Management</h2>
    <button class="btn btn-primary" onclick="openCreateInvoiceModal()">+ Create Invoice</button>
</div>

<div class="card">
    <h3>Recent Invoices</h3>
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Invoice #</th>
                    <th>Customer Name</th>
                    <th>Product Name</th>
                    <th>Price Sold</th>
                    <th>Quantity</th>
                    <th>Line Total</th>
                    <th>Shipment/Delivery Fee</th>
                    <th>Total</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if invoices %}
                    {% for invoice in invoices %}
                        {% set items_list = invoice.get('items_parsed', []) %}
                        {% set shipment_fee = invoice.get('shipment_fee', 0) %}
                        {% if shipment_fee is none or shipment_fee == '' %}
                            {% set shipment_fee = 0 %}
                        {% else %}
                            {% set shipment_fee = shipment_fee|float %}
                        {% endif %}
                        {% set products_summary = invoice.get('products_summary', '') %}
                        {% if items_list %}
                            {% for item in items_list %}
                            <tr>
                                {% if loop.first %}
                                <td rowspan="{{ items_list|length }}" style="vertical-align: middle; text-align: center; padding-top: 1rem;">
                                    <strong>{{ invoice.get('invoice_number', 'N/A') }}</strong>
                                </td>
                                <td rowspan="{{ items_list|length }}" style="vertical-align: middle; text-align: center; padding-top: 1rem;">
                                    {{ invoice.get('customer_name', 'N/A') }}
                                </td>
                                {% endif %}
                                <td style="text-align: center;">{{ item.get('name', 'N/A') }}</td>
                                <td style="text-align: center;">₱{{ "%.2f"|format(item.get('price', 0)) }}</td>
                                <td style="text-align: center;">{{ item.get('quantity', 0) }}</td>
                                <td style="text-align: center;">₱{{ "%.2f"|format(item.get('subtotal', 0)) }}</td>
                                {% if loop.first %}
                                <td rowspan="{{ items_list|length }}" style="vertical-align: middle; text-align: center; padding-top: 1rem;">
                                    ₱{{ "%.2f"|format(shipment_fee) }}
                                </td>
                                <td rowspan="{{ items_list|length }}" style="vertical-align: middle; text-align: center; padding-top: 1rem;">
                                    <strong>₱{{ "%.2f"|format(invoice.get('total_amount', 0)) }}</strong>
                                </td>
                                <td rowspan="{{ items_list|length }}" style="vertical-align: middle; text-align: center; padding-top: 1rem;">
                                    {{ invoice.get('invoice_date', '-') }}
                                </td>
                                <td rowspan="{{ items_list|length }}" style="vertical-align: middle; text-align: center; padding-top: 1rem;">
                                    <div style="display: flex; gap: 0.5rem; flex-direction: column; align-items: center;">
                                        <button class="btn btn-sm btn-primary" onclick="viewInvoice('{{ invoice.get('invoice_number', '')|e }}', {{ invoice.get('items_parsed', [])|tojson|safe }}, '{{ invoice.get('customer_name', '')|e }}', '{{ invoice.get('invoice_date', '')|e }}', {{ invoice.get('total_amount', 0) }}, {{ shipment_fee }})">
                                            View
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteInvoice('{{ invoice.get('invoice_number', '')|e }}')">
                                            Delete
                                        </button>
                                    </div>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td style="text-align: center;"><strong>{{ invoice.get('invoice_number', 'N/A') }}</strong></td>
                                <td style="text-align: center;">{{ invoice.get('customer_name', 'N/A') }}</td>
                                <td colspan="3" class="text-center text-muted">No items</td>
                                <td style="text-align: center;">₱{{ "%.2f"|format(shipment_fee) }}</td>
                                <td style="text-align: center;"><strong>₱{{ "%.2f"|format(invoice.get('total_amount', 0)) }}</strong></td>
                                <td style="text-align: center;">{{ invoice.get('invoice_date', '-') }}</td>
                                <td style="text-align: center;">
                                    <div style="display: flex; gap: 0.5rem; flex-direction: column; align-items: center;">
                                        <button class="btn btn-sm btn-primary" onclick="viewInvoice('{{ invoice.get('invoice_number', '')|e }}', [], '{{ invoice.get('customer_name', '')|e }}', '{{ invoice.get('invoice_date', '')|e }}', {{ invoice.get('total_amount', 0) }}, {{ shipment_fee }})">
                                            View
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteInvoice('{{ invoice.get('invoice_number', '')|e }}')">
                                            Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="10" class="text-center">No invoices yet. Create your first invoice!</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<div class="card">
    <h3>Customers</h3>
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Customer Name</th>
                    <th>Total Orders</th>
                    <th>Total Spent</th>
                    <th>Products Purchased</th>
                    <th>First Order</th>
                    <th>Last Order</th>
                </tr>
            </thead>
            <tbody>
                {% if customers %}
                    {% for customer in customers %}
                    <tr>
                        <td>{{ customer.get('customer_name', 'N/A') }}</td>
                        <td>{{ customer.get('total_orders', 0) }}</td>
                        <td>₱{{ "%.2f"|format(customer.get('total_spent', 0)) }}</td>
                        <td>
                            {% set products_dict = customer.get('products_parsed', {}) %}
                            {% if products_dict %}
                                {% for product_name, details in products_dict.items() %}
                                    <div style="margin-bottom: 0.25rem;">
                                        <strong>{{ product_name }}</strong>: 
                                        {{ details.get('qty', 0) }} pcs sold, Total: ₱{{ "%.2f"|format(details.get('total_amount', 0)) }}
                                    </div>
                                {% endfor %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ customer.get('first_order_date', '-') }}</td>
                        <td>{{ customer.get('last_order_date', '-') }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="6" class="text-center">No customers yet.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Create Invoice Modal -->
<div id="createInvoiceModal" class="modal">
    <div class="modal-content modal-large">
        <span class="close" onclick="closeCreateInvoiceModal()">&times;</span>
        <h3>Create New Invoice</h3>
        <form id="createInvoiceForm" onsubmit="createInvoice(event)">
            <div class="form-group">
                <label>Customer Name *</label>
                <input type="text" name="customer_name" id="customerName" required list="customerList">
                <datalist id="customerList">
                    {% for customer in customers %}
                    <option value="{{ customer.get('customer_name', '') }}">
                    {% endfor %}
                </datalist>
            </div>
            <div class="form-group">
                <label>Invoice Date</label>
                <input type="date" name="invoice_date" value="{{ today }}" required>
            </div>
            
            <div class="invoice-items-section">
                <h4>Items</h4>
                <div id="invoiceItems">
                    <div class="invoice-item">
                        <div class="form-group" style="position: relative; flex: 1;">
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem;">Product Name *</label>
                            <input type="text" class="item-name-input" placeholder="Type to search products..." autocomplete="off" required>
                            <input type="hidden" class="item-name-hidden" required>
                            <div class="autocomplete-suggestions" style="display: none;"></div>
                        </div>
                        <div class="form-group" style="flex: 0 0 150px;">
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem;">Price Sold (₱) *</label>
                            <input type="number" step="0.01" placeholder="0.00" class="item-price" required oninput="updateInvoiceTotal()">
                        </div>
                        <div class="form-group" style="flex: 0 0 100px;">
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem;">Quantity *</label>
                            <input type="number" placeholder="1" class="item-qty" value="1" required oninput="updateInvoiceTotal()">
                        </div>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(this)" style="align-self: flex-end; margin-top: 1.5rem;">Remove</button>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="addInvoiceItem()">+ Add Item</button>
            </div>
            
            <div class="form-group" style="margin-top: 1.5rem;">
                <label>Shipment/Delivery Fee (₱)</label>
                <input type="number" step="0.01" name="shipment_fee" id="shipmentFee" value="0" placeholder="0.00" oninput="updateInvoiceTotal()" style="max-width: 200px;">
                <small style="display: block; color: #666; margin-top: 0.25rem;">Optional shipping or delivery fee</small>
            </div>
            
            <div class="invoice-total">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Subtotal:</span>
                    <span>₱<span id="invoiceSubtotal">0.00</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Shipment/Delivery Fee:</span>
                    <span>₱<span id="shipmentFeeDisplay">0.00</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 2px solid #6366f1; margin-top: 0.5rem;">
                    <strong>Total:</strong>
                    <strong>₱<span id="invoiceTotal">0.00</span></strong>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeCreateInvoiceModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Invoice</button>
            </div>
        </form>
    </div>
</div>

<!-- View Invoice Modal -->
<div id="viewInvoiceModal" class="modal">
    <div class="modal-content modal-large invoice-view-modal">
        <span class="close" onclick="closeViewInvoiceModal()">&times;</span>
        <div class="invoice-view-header">
            <h2>INVOICE</h2>
            <div class="invoice-customer-name" id="viewCustomerNameTop"></div>
            <p id="viewInvoiceNumber" class="invoice-number"></p>
        </div>
        
        <div class="invoice-view-info">
            <div class="invoice-view-info-block">
                <h3>Invoice Date:</h3>
                <p id="viewInvoiceDate"></p>
            </div>
        </div>
        
        <div class="invoice-view-table-container">
            <table class="invoice-view-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Product Name</th>
                        <th>Quantity</th>
                        <th>Price Per Piece</th>
                        <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody id="viewInvoiceItemsBody">
                    <!-- Items will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
        
        <div class="invoice-view-totals">
            <div class="invoice-totals-row">
                <span class="invoice-totals-label">Subtotal:</span>
                <span class="invoice-totals-value" id="viewSubtotal">₱0.00</span>
            </div>
            <div class="invoice-totals-row">
                <span class="invoice-totals-label">Shipment/Delivery Fee:</span>
                <span class="invoice-totals-value" id="viewShipmentFee">₱0.00</span>
            </div>
            <div class="invoice-totals-row invoice-totals-final">
                <span class="invoice-totals-label">Total Amount:</span>
                <span class="invoice-totals-value" id="viewTotalAmount">₱0.00</span>
            </div>
        </div>
        
        <div class="invoice-view-actions">
            <button class="btn btn-secondary" onclick="downloadInvoice()">Download Invoice</button>
            <button class="btn btn-primary" onclick="closeViewInvoiceModal()">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.invoice-items-section {
    margin: 1.5rem 0;
}

.invoice-item {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
    margin-bottom: 1rem;
    padding: 1rem;
    background-color: #f9fafb;
    border-radius: 0.5rem;
    border: 1px solid #e5e7eb;
}

.invoice-item .form-group {
    display: flex;
    flex-direction: column;
}

.invoice-item .item-name-input,
.invoice-item .item-price,
.invoice-item .item-qty {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 0.375rem;
    font-size: 0.875rem;
}

.invoice-item .item-name-input:focus,
.invoice-item .item-price:focus,
.invoice-item .item-qty:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.autocomplete-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 0.5rem 0.5rem;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1001;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.autocomplete-suggestion {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s;
    font-size: 0.875rem;
}

.autocomplete-suggestion:hover,
.autocomplete-suggestion.highlighted {
    background-color: #6366f1;
    color: white;
}

.autocomplete-suggestion:last-child {
    border-bottom: none;
}

.modal-large {
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
}

.invoice-total {
    margin: 1.5rem 0;
    padding: 1rem;
    background-color: #f0f0f0;
    border-radius: 0.5rem;
    text-align: right;
    font-size: 1.25rem;
}

/* Invoice View Modal Styles */
.invoice-view-modal {
    background: linear-gradient(135deg, #e6e6fa 0%, #d8bfd8 50%, #dda0dd 100%);
    border-radius: 16px;
    padding: 0;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.invoice-view-modal .modal-content {
    background: white;
    margin: 20px;
    border-radius: 12px;
    padding: 40px;
    max-height: calc(100vh - 80px);
    overflow-y: auto;
}

.invoice-view-header {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 3px solid #d8bfd8;
}

.invoice-view-header h2 {
    color: #9370db;
    margin: 0;
    font-size: 32px;
    font-weight: 700;
}

.invoice-customer-name {
    font-size: 28px;
    color: #4b0082;
    margin: 20px 0 10px 0;
    font-weight: 700;
    text-align: center;
    padding: 15px;
    background: linear-gradient(135deg, #f5f0ff 0%, #e6e6fa 100%);
    border-radius: 8px;
    border: 2px solid #d8bfd8;
}

.invoice-number {
    font-size: 20px;
    color: #9370db;
    margin-top: 10px;
    font-weight: 600;
}

.invoice-view-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #f5f0ff 0%, #f0e6ff 100%);
    border-radius: 8px;
}

.invoice-view-info-block {
    flex: 1;
}

.invoice-view-info-block h3 {
    color: #9370db;
    margin: 0 0 10px 0;
    font-size: 14px;
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.5px;
}

.invoice-view-info-block p {
    margin: 0;
    font-size: 18px;
    color: #4b0082;
    font-weight: 500;
}

.invoice-view-table-container {
    margin-bottom: 30px;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.invoice-view-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

.invoice-view-table thead {
    background: linear-gradient(135deg, #d8bfd8 0%, #dda0dd 100%);
}

.invoice-view-table th {
    color: #4b0082;
    padding: 15px;
    text-align: center;
    font-weight: 600;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.invoice-view-table td {
    padding: 15px;
    border-bottom: 1px solid #e6e6fa;
    color: #333;
    font-size: 15px;
}

.invoice-view-table tbody tr {
    transition: all 0.2s ease;
}

.invoice-view-table tbody tr:hover {
    background-color: #f5f0ff;
    transform: translateX(2px);
    box-shadow: 0 2px 4px rgba(147, 112, 219, 0.1);
}

.invoice-view-table tbody tr:last-child td {
    border-bottom: none;
}

.invoice-view-table tbody tr:nth-child(even) {
    background-color: #faf9ff;
}

.invoice-view-table tbody tr:nth-child(even):hover {
    background-color: #f5f0ff;
}

.invoice-view-totals {
    margin-top: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #f5f0ff 0%, #f0e6ff 100%);
    border-radius: 8px;
    text-align: right;
}

.invoice-totals-row {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 10px;
    padding: 8px 0;
    align-items: center;
}

.invoice-totals-label {
    width: 200px;
    text-align: right;
    padding-right: 20px;
    font-weight: 500;
    color: #4b0082;
}

.invoice-totals-value {
    width: 150px;
    text-align: right;
    font-weight: 600;
    color: #333;
}

.invoice-totals-final {
    border-top: 2px solid #9370db;
    padding-top: 15px;
    margin-top: 15px;
    font-size: 20px;
}

.invoice-totals-final .invoice-totals-label,
.invoice-totals-final .invoice-totals-value {
    color: #4b0082;
    font-size: 20px;
}

.invoice-view-actions {
    margin-top: 30px;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding-top: 20px;
    border-top: 2px solid #d8bfd8;
}
</style>
<script>
// Store product names from server
const allProducts = {% if product_names %}{{ product_names|tojson }}{% else %}[]{% endif %}.filter(p => p && p.trim());

let invoiceItems = [];
let selectedProductIndices = {}; // Track selected product index for each item

function openCreateInvoiceModal() {
    document.getElementById('createInvoiceModal').style.display = 'block';
    invoiceItems = [];
    updateInvoiceTotal();
    // Initialize autocomplete for existing items
    document.querySelectorAll('.invoice-item').forEach(item => {
        initializeAutocomplete(item);
    });
}

function closeCreateInvoiceModal() {
    document.getElementById('createInvoiceModal').style.display = 'none';
    document.getElementById('createInvoiceForm').reset();
    // Reset to single empty item with autocomplete
    document.getElementById('invoiceItems').innerHTML = `
        <div class="invoice-item">
            <div class="form-group" style="position: relative; flex: 1;">
                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem;">Product Name *</label>
                <input type="text" class="item-name-input" placeholder="Type to search products..." autocomplete="off" required>
                <input type="hidden" class="item-name-hidden" required>
                <div class="autocomplete-suggestions" style="display: none;"></div>
            </div>
            <div class="form-group" style="flex: 0 0 150px;">
                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem;">Price Sold (₱) *</label>
                <input type="number" step="0.01" placeholder="0.00" class="item-price" required oninput="updateInvoiceTotal()">
            </div>
            <div class="form-group" style="flex: 0 0 100px;">
                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem;">Quantity *</label>
                <input type="number" placeholder="1" class="item-qty" value="1" required oninput="updateInvoiceTotal()">
            </div>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(this)" style="align-self: flex-end; margin-top: 1.5rem;">Remove</button>
        </div>
    `;
    invoiceItems = [];
    selectedProductIndices = {};
    updateInvoiceTotal();
    // Reinitialize autocomplete for the new item
    initializeAutocomplete(document.querySelector('.invoice-item:last-child'));
}

function addInvoiceItem() {
    const itemsDiv = document.getElementById('invoiceItems');
    const newItem = document.createElement('div');
    newItem.className = 'invoice-item';
    newItem.innerHTML = `
        <div class="form-group" style="position: relative; flex: 1;">
            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem;">Product Name *</label>
            <input type="text" class="item-name-input" placeholder="Type to search products..." autocomplete="off" required>
            <input type="hidden" class="item-name-hidden" required>
            <div class="autocomplete-suggestions" style="display: none;"></div>
        </div>
        <div class="form-group" style="flex: 0 0 150px;">
            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem;">Price Sold (₱) *</label>
            <input type="number" step="0.01" placeholder="0.00" class="item-price" required oninput="updateInvoiceTotal()">
        </div>
        <div class="form-group" style="flex: 0 0 100px;">
            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem;">Quantity *</label>
            <input type="number" placeholder="1" class="item-qty" value="1" required oninput="updateInvoiceTotal()">
        </div>
        <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(this)" style="align-self: flex-end; margin-top: 1.5rem;">Remove</button>
    `;
    itemsDiv.appendChild(newItem);
    initializeAutocomplete(newItem);
}

function removeItem(button) {
    button.parentElement.remove();
    updateInvoiceTotal();
}

function initializeAutocomplete(itemElement) {
    const input = itemElement.querySelector('.item-name-input');
    const hidden = itemElement.querySelector('.item-name-hidden');
    const suggestions = itemElement.querySelector('.autocomplete-suggestions');
    let selectedIndex = -1;
    
    if (!input || !hidden || !suggestions) return;
    
    function filterProducts(query) {
        if (query.length === 0) {
            return allProducts.slice(0, 7);
        }
        const matches = allProducts.filter(product => 
            product.toLowerCase().includes(query.toLowerCase())
        );
        return matches.slice(0, Math.max(7, matches.length));
    }
    
    function showSuggestions(matches) {
        if (matches.length === 0) {
            suggestions.innerHTML = '<div class="autocomplete-suggestion" style="color: #999; cursor: default;">No products found</div>';
            suggestions.style.display = 'block';
            return;
        }
        
        let html = '';
        matches.forEach((product, index) => {
            const highlighted = product.replace(
                new RegExp(`(${input.value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi'),
                '<strong>$1</strong>'
            );
            const escapedProduct = product.replace(/"/g, '&quot;');
            html += `<div class="autocomplete-suggestion" data-index="${index}" data-product="${escapedProduct}" onclick="selectProductFromData(this)">${highlighted}</div>`;
        });
        suggestions.innerHTML = html;
        suggestions.style.display = 'block';
        selectedIndex = -1;
    }
    
    function selectProduct(productName) {
        input.value = productName;
        hidden.value = productName;
        suggestions.style.display = 'none';
        selectedIndex = -1;
    }
    
    input.addEventListener('input', function() {
        const query = input.value.trim();
        const matches = filterProducts(query);
        showSuggestions(matches);
    });
    
    input.addEventListener('focus', function() {
        if (input.value.trim().length > 0) {
            const matches = filterProducts(input.value.trim());
            showSuggestions(matches);
        } else {
            showSuggestions(allProducts.slice(0, 7));
        }
    });
    
    input.addEventListener('blur', function() {
        setTimeout(() => {
            suggestions.style.display = 'none';
        }, 200);
    });
    
    input.addEventListener('keydown', function(e) {
        const suggestionElements = suggestions.querySelectorAll('.autocomplete-suggestion');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, suggestionElements.length - 1);
            suggestionElements.forEach((el, idx) => {
                if (idx === selectedIndex) {
                    el.classList.add('highlighted');
                } else {
                    el.classList.remove('highlighted');
                }
            });
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            suggestionElements.forEach((el, idx) => {
                if (idx === selectedIndex) {
                    el.classList.add('highlighted');
                } else {
                    el.classList.remove('highlighted');
                }
            });
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
            e.preventDefault();
            const selected = suggestionElements[selectedIndex];
            if (selected && selected.dataset.product) {
                selectProduct(selected.dataset.product);
            }
        } else if (e.key === 'Escape') {
            suggestions.style.display = 'none';
            selectedIndex = -1;
        }
    });
}

function selectProductFromData(element) {
    const productName = element.getAttribute('data-product');
    const itemElement = element.closest('.invoice-item');
    const input = itemElement.querySelector('.item-name-input');
    const hidden = itemElement.querySelector('.item-name-hidden');
    
    if (input && hidden) {
        input.value = productName;
        hidden.value = productName;
        itemElement.querySelector('.autocomplete-suggestions').style.display = 'none';
    }
}

function updateInvoiceTotal() {
    const items = document.querySelectorAll('.invoice-item');
    let subtotal = 0;
    items.forEach(item => {
        const price = parseFloat(item.querySelector('.item-price').value) || 0;
        const qty = parseFloat(item.querySelector('.item-qty').value) || 0;
        subtotal += price * qty;
    });
    
    const shipmentFee = parseFloat(document.getElementById('shipmentFee').value) || 0;
    const total = subtotal + shipmentFee;
    
    document.getElementById('invoiceSubtotal').textContent = subtotal.toFixed(2);
    document.getElementById('shipmentFeeDisplay').textContent = shipmentFee.toFixed(2);
    document.getElementById('invoiceTotal').textContent = total.toFixed(2);
}

function createInvoice(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const customerName = formData.get('customer_name');
    const invoiceDate = formData.get('invoice_date');
    
    // Collect items
    const items = [];
    const itemRows = document.querySelectorAll('.invoice-item');
    itemRows.forEach(row => {
        const hiddenInput = row.querySelector('.item-name-hidden');
        const name = hiddenInput ? hiddenInput.value : '';
        const price = parseFloat(row.querySelector('.item-price').value) || 0;
        const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
        if (name && name.trim() && price > 0 && qty > 0) {
            items.push({
                name: name.trim(),
                price: price,
                quantity: qty,
                subtotal: price * qty
            });
        }
    });
    
    if (items.length === 0) {
        alert('Please add at least one item with a product name, price, and quantity.');
        return;
    }
    
    const shipmentFee = parseFloat(document.getElementById('shipmentFee').value) || 0;
    const subtotal = items.reduce((sum, item) => sum + item.subtotal, 0);
    const totalAmount = subtotal + shipmentFee;
    
    fetch('/api/create_invoice', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            customer_name: customerName,
            items: items,
            subtotal: subtotal,
            shipment_fee: shipmentFee,
            total_amount: totalAmount,
            invoice_date: invoiceDate
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Invoice created successfully! Invoice #: ' + result.invoice_number);
            location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function viewInvoice(invoiceNumber, items, customerName, invoiceDate, totalAmount, shipmentFee) {
    let itemsList = [];
    try {
        // Handle different input types safely
        if (items === null || items === undefined) {
            itemsList = [];
        } else if (typeof items === 'string') {
            // Try JSON first
            try {
                const parsed = JSON.parse(items);
                itemsList = Array.isArray(parsed) ? parsed : [];
            } catch (jsonError) {
                // If JSON fails, check if it's an empty string or invalid
                console.warn('Could not parse items as JSON:', jsonError);
                itemsList = [];
            }
        } else if (Array.isArray(items)) {
            itemsList = items;
        } else if (items && typeof items === 'object') {
            // Handle case where items might be an object - convert to array
            itemsList = Object.values(items).filter(v => v !== null && v !== undefined);
        }
        
        // Ensure itemsList is an array and has valid structure
        if (!Array.isArray(itemsList)) {
            itemsList = [];
        }
        
        // Validate each item has required fields
        itemsList = itemsList.filter(item => {
            if (!item || typeof item !== 'object') return false;
            return (item.name || item.product_name) && 
                   (item.price !== undefined) && 
                   (item.quantity !== undefined) && 
                   (item.subtotal !== undefined);
        });
        
        console.log('Parsed items successfully:', itemsList.length, 'items');
    } catch(e) {
        console.error('Error parsing items:', e);
        itemsList = [];
    }
    
    let subtotal = 0;
    itemsList.forEach((item) => {
        subtotal += parseFloat(item.subtotal || 0);
    });
    
    shipmentFee = shipmentFee || 0;
    
    // Populate modal
    document.getElementById('viewInvoiceNumber').textContent = invoiceNumber;
    document.getElementById('viewCustomerNameTop').textContent = customerName;
    document.getElementById('viewInvoiceDate').textContent = invoiceDate;
    
    // Populate items table
    const itemsTableBody = document.getElementById('viewInvoiceItemsBody');
    itemsTableBody.innerHTML = '';
    
    if (itemsList.length === 0) {
        itemsTableBody.innerHTML = '<tr><td colspan="5" class="text-center" style="padding: 30px; color: #999; font-style: italic;">No items in this invoice</td></tr>';
    } else {
        itemsList.forEach((item, index) => {
            const row = document.createElement('tr');
            const itemName = item.name || item.product_name || 'N/A';
            const itemPrice = parseFloat(item.price || 0);
            const itemQuantity = parseInt(item.quantity || 0);
            const itemSubtotal = parseFloat(item.subtotal || 0);
            
            row.innerHTML = `
                <td style="text-align: center;">${index + 1}</td>
                <td style="text-align: center;">${escapeHtml(itemName)}</td>
                <td style="text-align: center;">${itemQuantity}</td>
                <td style="text-align: center;">₱${itemPrice.toFixed(2)}</td>
                <td style="text-align: center;">₱${itemSubtotal.toFixed(2)}</td>
            `;
            itemsTableBody.appendChild(row);
        });
    }
    
    // Update totals
    document.getElementById('viewSubtotal').textContent = `₱${subtotal.toFixed(2)}`;
    document.getElementById('viewShipmentFee').textContent = `₱${parseFloat(shipmentFee).toFixed(2)}`;
    document.getElementById('viewTotalAmount').textContent = `₱${parseFloat(totalAmount).toFixed(2)}`;
    
    // Store data for download
    window.currentInvoiceData = {
        invoiceNumber,
        customerName,
        invoiceDate,
        items: itemsList,
        subtotal,
        shipmentFee,
        totalAmount
    };
    
    // Show modal
    document.getElementById('viewInvoiceModal').style.display = 'block';
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function closeViewInvoiceModal() {
    document.getElementById('viewInvoiceModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const viewModal = document.getElementById('viewInvoiceModal');
    if (event.target == viewModal) {
        closeViewInvoiceModal();
    }
}

function downloadInvoice() {
    if (!window.currentInvoiceData) return;
    
    const data = window.currentInvoiceData;
    const invoiceHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Invoice ${data.invoiceNumber}</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 40px;
            background: linear-gradient(135deg, #e6e6fa 0%, #d8bfd8 50%, #dda0dd 100%);
            min-height: 100vh;
        }
        .invoice-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .invoice-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #d8bfd8;
        }
        .invoice-header h1 {
            color: #9370db;
            margin: 0;
            font-size: 32px;
        }
        .invoice-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .info-block {
            flex: 1;
        }
        .info-block h3 {
            color: #9370db;
            margin: 0 0 10px 0;
            font-size: 14px;
            text-transform: uppercase;
        }
        .info-block p {
            margin: 5px 0;
            font-size: 16px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        th {
            background: linear-gradient(135deg, #d8bfd8 0%, #dda0dd 100%);
            color: #4b0082;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e6e6fa;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .totals {
            margin-top: 20px;
            text-align: right;
        }
        .totals-row {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
            padding: 8px 0;
        }
        .totals-label {
            width: 200px;
            text-align: right;
            padding-right: 20px;
            font-weight: 500;
        }
        .totals-value {
            width: 150px;
            text-align: right;
        }
        .total-final {
            border-top: 2px solid #9370db;
            padding-top: 15px;
            margin-top: 15px;
            font-size: 20px;
            font-weight: bold;
            color: #4b0082;
        }
    </style>
</head>
<body>
    <div class="invoice-container">
        <div class="invoice-header">
            <h1>INVOICE</h1>
            <p style="font-size: 24px; color: #9370db; margin-top: 10px;">${data.invoiceNumber}</p>
        </div>
        
        <div class="invoice-info">
            <div class="info-block">
                <h3>Bill To:</h3>
                <p style="font-size: 18px; font-weight: 600;">${data.customerName}</p>
            </div>
            <div class="info-block" style="text-align: right;">
                <h3>Invoice Date:</h3>
                <p style="font-size: 18px;">${data.invoiceDate}</p>
            </div>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Product Name</th>
                    <th>Quantity</th>
                    <th>Price Per Piece</th>
                    <th>Subtotal</th>
                </tr>
            </thead>
            <tbody>
                ${data.items.map((item, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>₱${parseFloat(item.price).toFixed(2)}</td>
                        <td>₱${parseFloat(item.subtotal).toFixed(2)}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        
        <div class="totals">
            <div class="totals-row">
                <div class="totals-label">Subtotal:</div>
                <div class="totals-value">₱${data.subtotal.toFixed(2)}</div>
            </div>
            <div class="totals-row">
                <div class="totals-label">Shipment/Delivery Fee:</div>
                <div class="totals-value">₱${parseFloat(data.shipmentFee).toFixed(2)}</div>
            </div>
            <div class="totals-row total-final">
                <div class="totals-label">Total Amount:</div>
                <div class="totals-value">₱${parseFloat(data.totalAmount).toFixed(2)}</div>
            </div>
        </div>
    </div>
</body>
</html>
    `;
    
    const blob = new Blob([invoiceHTML], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Invoice_${data.invoiceNumber}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function deleteInvoice(invoiceNumber) {
    if (!confirm(`Are you sure you want to delete invoice ${invoiceNumber}? This action cannot be undone.`)) {
        return;
    }
    
    fetch('/api/delete_invoice', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ invoice_number: invoiceNumber })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Invoice deleted successfully!');
            location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

// Update total when inputs change and initialize autocomplete
document.addEventListener('DOMContentLoaded', function() {
    const itemsDiv = document.getElementById('invoiceItems');
    if (itemsDiv) {
        itemsDiv.addEventListener('input', function(e) {
            if (e.target.classList.contains('item-price') || e.target.classList.contains('item-qty')) {
                updateInvoiceTotal();
            }
        });
        // Initialize autocomplete for initial item
        const initialItem = itemsDiv.querySelector('.invoice-item');
        if (initialItem) {
            initializeAutocomplete(initialItem);
        }
    }
});

window.onclick = function(event) {
    const modal = document.getElementById('createInvoiceModal');
    if (event.target == modal) {
        closeCreateInvoiceModal();
    }
}
</script>
{% endblock %}


