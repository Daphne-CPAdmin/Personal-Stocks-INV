{% extends "base.html" %}

{% block title %}Inventory - Inventory Manager{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Product Inventory</h2>
    <button class="btn btn-primary" onclick="openAddProductModal()">+ Add Product</button>
</div>

<div class="card">
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Product Name</th>
                    <th>Total Price</th>
                    <th>Shipping Admin Fee</th>
                    <th>Total Cost/Unit</th>
                    <th>Quantity</th>
                    <th>Total Bought</th>
                    <th>Remaining</th>
                    <th>Date Added</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if items %}
                    {% for item in items %}
                    <tr>
                        <td>{{ item.get('product_name', 'N/A') }}</td>
                        <td>₱{{ "%.2f"|format(item.get('total_price', 0)) }}</td>
                        <td>₱{{ "%.2f"|format(item.get('shipping_admin_fee', 0)) }}</td>
                        <td>₱{{ "%.2f"|format(item.get('total_cost_per_unit', 0)) }}</td>
                        <td>{{ item.get('quantity', 0) }}</td>
                        <td>{{ item.get('total_bought_quantity', item.get('quantity', 0)) }}</td>
                        <td>
                            {% set remaining = item.get('remaining_qty', item.get('quantity', 0)) %}
                            {% set total_bought = item.get('total_bought_quantity', item.get('quantity', 1)) %}
                            {% set percentage = (remaining / total_bought * 100) if total_bought > 0 else 0 %}
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="flex: 1; background-color: #e5e7eb; border-radius: 0.25rem; height: 24px; position: relative; overflow: hidden;">
                                    <div style="background-color: {% if percentage > 50 %}#10b981{% elif percentage > 25 %}#f59e0b{% else %}#ef4444{% endif %}; height: 100%; width: {{ percentage }}%; transition: width 0.3s;"></div>
                                </div>
                                <span style="min-width: 40px; text-align: right; font-weight: 600;">{{ remaining }}</span>
                            </div>
                        </td>
                        <td>{{ item.get('date_added', '-') }}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="openStatusModal({{ loop.index0 }}, '{{ item.get('product_name', '') }}', 'in_stock', {{ item.get('remaining_qty', item.get('quantity', 0)) }})">
                                Update Status
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="8" class="text-center">No products in inventory. Add your first product!</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Product Modal -->
<div id="addProductModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddProductModal()">&times;</span>
        <h3>Add New Product</h3>
        <form id="addProductForm" onsubmit="addProduct(event)">
            <div class="form-group">
                <label>Product Name *</label>
                <select name="product_name" id="productNameSelect" required>
                    <option value="">-- Select Product --</option>
                    {% if product_names %}
                        {% for product_name in product_names %}
                        <option value="{{ product_name }}">{{ product_name }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Total Price (₱) *</label>
                    <input type="number" step="0.01" name="total_price" id="totalPriceInput" required>
                </div>
                <div class="form-group">
                    <label>Shipping Admin Fee (₱) *</label>
                    <input type="number" step="0.01" name="shipping_admin_fee" id="shippingAdminFeeInput" required>
                </div>
            </div>
            <div class="form-group">
                <label>Quantity *</label>
                <input type="number" name="quantity" id="quantityInput" value="1" required oninput="updateCalculatedCost()">
            </div>
            <div class="form-group" style="background-color: #f0f0f0; padding: 1rem; border-radius: 0.5rem;">
                <strong>Calculated Total Cost Per Unit:</strong> 
                <span id="calculatedCostPerUnit" style="color: #6366f1; font-size: 1.2em;">₱0.00</span>
                <small style="display: block; color: #666; margin-top: 0.5rem;">
                    Formula: (Total Price + Shipping Admin Fee) ÷ Quantity
                </small>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeAddProductModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Product</button>
            </div>
        </form>
    </div>
</div>

<!-- Update Status Modal -->
<div id="statusModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeStatusModal()">&times;</span>
        <h3>Update Product Status</h3>
        <p><strong>Product:</strong> <span id="statusProductName"></span></p>
        <p><strong>Remaining Quantity:</strong> <span id="statusRemainingQty"></span></p>
        <form id="statusForm" onsubmit="updateStatus(event)">
            <input type="hidden" id="statusProductId" name="product_id">
            <div class="form-group">
                <label>Status *</label>
                <select id="statusSelect" name="status" required onchange="toggleFields()">
                    <option value="in_stock">In Stock</option>
                    <option value="used">Used</option>
                    <option value="freebie">Freebie</option>
                    <option value="raffled">Raffled</option>
                    <option value="sold">Sold</option>
                </select>
            </div>
            <div class="form-group" id="quantityUsedGroup" style="display: none;">
                <label>Quantity Used/Sold/Given *</label>
                <input type="number" id="quantityUsed" name="quantity_used" min="1" value="1" required>
                <small style="color: #666;">How many items are being marked as this status?</small>
            </div>
            <div class="form-group" id="sellingPriceGroup" style="display: none;">
                <label>Selling Price (₱) *</label>
                <input type="number" step="0.01" id="sellingPrice" name="selling_price">
            </div>
            <div class="form-group">
                <label>Remarks</label>
                <textarea name="remarks" rows="3"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeStatusModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Status</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function openAddProductModal() {
    document.getElementById('addProductModal').style.display = 'block';
}

function closeAddProductModal() {
    document.getElementById('addProductModal').style.display = 'none';
    document.getElementById('addProductForm').reset();
}

function openStatusModal(index, productName, currentStatus, remainingQty) {
    document.getElementById('statusProductId').value = index;
    document.getElementById('statusProductName').textContent = productName;
    document.getElementById('statusRemainingQty').textContent = remainingQty;
    document.getElementById('statusSelect').value = currentStatus;
    document.getElementById('quantityUsed').max = remainingQty;
    document.getElementById('quantityUsed').value = Math.min(1, remainingQty);
    document.getElementById('statusModal').style.display = 'block';
    toggleFields();
}

function closeStatusModal() {
    document.getElementById('statusModal').style.display = 'none';
    document.getElementById('statusForm').reset();
}

function toggleFields() {
    const status = document.getElementById('statusSelect').value;
    const sellingPriceGroup = document.getElementById('sellingPriceGroup');
    const quantityUsedGroup = document.getElementById('quantityUsedGroup');
    const sellingPrice = document.getElementById('sellingPrice');
    
    // Show quantity field for sold, used, freebie
    if (status === 'sold' || status === 'used' || status === 'freebie') {
        quantityUsedGroup.style.display = 'block';
        document.getElementById('quantityUsed').required = true;
    } else {
        quantityUsedGroup.style.display = 'none';
        document.getElementById('quantityUsed').required = false;
    }
    
    // Show selling price only for sold
    if (status === 'sold') {
        sellingPriceGroup.style.display = 'block';
        sellingPrice.required = true;
    } else {
        sellingPriceGroup.style.display = 'none';
        sellingPrice.required = false;
    }
}

function calculateCostPerUnit() {
    const totalPrice = parseFloat(document.getElementById('totalPriceInput').value) || 0;
    const shippingAdminFee = parseFloat(document.getElementById('shippingAdminFeeInput').value) || 0;
    const quantity = parseFloat(document.getElementById('quantityInput').value) || 1;
    
    if (quantity > 0) {
        const costPerUnit = (totalPrice + shippingAdminFee) / quantity;
        document.getElementById('calculatedCostPerUnit').textContent = '₱' + costPerUnit.toFixed(2);
    } else {
        document.getElementById('calculatedCostPerUnit').textContent = '₱0.00';
    }
}

function addProduct(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    
    fetch('/api/add_product', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Product added successfully!');
            location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

// Add event listeners for calculation
document.addEventListener('DOMContentLoaded', function() {
    const totalPriceInput = document.getElementById('totalPriceInput');
    const shippingAdminFeeInput = document.getElementById('shippingAdminFeeInput');
    const quantityInput = document.getElementById('quantityInput');
    
    if (totalPriceInput) {
        totalPriceInput.addEventListener('input', calculateCostPerUnit);
    }
    if (shippingAdminFeeInput) {
        shippingAdminFeeInput.addEventListener('input', calculateCostPerUnit);
    }
    if (quantityInput) {
        quantityInput.addEventListener('input', calculateCostPerUnit);
    }
});

function updateStatus(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    
    fetch('/api/update_status', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Status updated successfully!');
            location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

// Close modal when clicking outside
window.onclick = function(event) {
    const addModal = document.getElementById('addProductModal');
    const statusModal = document.getElementById('statusModal');
    if (event.target == addModal) {
        closeAddProductModal();
    }
    if (event.target == statusModal) {
        closeStatusModal();
    }
}
</script>
{% endblock %}


