{% extends "base.html" %}

{% block title %}Inventory - Deej - Inventory Manager{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Product Inventory</h2>
    <button class="btn btn-primary" onclick="openAddProductModal()">+ Add Product</button>
</div>

<div class="card">
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Product Name</th>
                    <th>Total Price</th>
                    <th>Shipping Admin Fee</th>
                    <th>Total Cost/Unit</th>
                    <th>Quantity</th>
                    <th>Total Bought</th>
                    <th>Remaining</th>
                    <th>Date Added</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if items %}
                    {% for item in items %}
                    <tr>
                        <td title="{{ item.get('product_name', 'N/A') }}">{{ item.get('product_name', 'N/A') }}</td>
                        <td>₱{{ "%.2f"|format(item.get('total_price', 0)) }}</td>
                        <td>₱{{ "%.2f"|format(item.get('shipping_admin_fee', 0)) }}</td>
                        <td>₱{{ "%.2f"|format(item.get('total_cost_per_unit', 0)) }}</td>
                        <td>{{ item.get('quantity', 0) }}</td>
                        <td>{{ item.get('total_bought_quantity', item.get('quantity', 0)) }}</td>
                        <td>
                            {% set remaining = item.get('remaining_qty', item.get('quantity', 0)) %}
                            {% set total_bought = item.get('total_bought_quantity', item.get('quantity', 1)) %}
                            {% set percentage = (remaining / total_bought * 100) if total_bought > 0 else 0 %}
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="flex: 1; background-color: #e5e7eb; border-radius: 0.25rem; height: 20px; position: relative; overflow: hidden; min-width: 60px;">
                                    <div style="background-color: {% if percentage > 50 %}#10b981{% elif percentage > 25 %}#f59e0b{% else %}#ef4444{% endif %}; height: 100%; width: {{ percentage }}%; transition: width 0.3s;"></div>
                                </div>
                                <span style="min-width: 30px; text-align: right; font-weight: 600; font-size: 0.8125rem;">{{ remaining }}</span>
                            </div>
                        </td>
                        <td style="font-size: 0.75rem;">{{ item.get('date_added', '-') }}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="openStatusModal({{ loop.index0 }}, '{{ item.get('product_name', '') }}', 'in_stock', {{ item.get('remaining_qty', item.get('quantity', 0)) }})" style="font-size: 0.75rem; padding: 0.4rem 0.8rem;">
                                Update Status
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="8" class="text-center">No products in inventory. Add your first product!</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Product Modal -->
<div id="addProductModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddProductModal()">&times;</span>
        <h3>Add New Product</h3>
        <form id="addProductForm" onsubmit="addProduct(event)">
            <div class="form-group">
                <label>Product Name *</label>
                <div style="position: relative;">
                    <input type="text" 
                           id="productNameInput" 
                           placeholder="Type to search products..." 
                           autocomplete="off"
                           oninput="filterProducts()"
                           onfocus="showProductSuggestions()"
                           onblur="hideProductSuggestions()">
                    <input type="hidden" id="productNameHidden" name="product_name" required>
                    <div id="productSuggestions" class="autocomplete-suggestions" style="display: none;"></div>
                </div>
                <small style="color: #666; display: block; margin-top: 0.25rem;">Start typing to filter products</small>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Total Price (₱) *</label>
                    <input type="number" step="0.01" name="total_price" id="totalPriceInput" required>
                </div>
                <div class="form-group">
                    <label>Shipping Admin Fee (₱) *</label>
                    <input type="number" step="0.01" name="shipping_admin_fee" id="shippingAdminFeeInput" required>
                </div>
            </div>
            <div class="form-group">
                <label>Quantity *</label>
                <input type="number" name="quantity" id="quantityInput" value="1" required oninput="updateCalculatedCost()">
            </div>
            <div class="form-group" style="background-color: #f0f0f0; padding: 1rem; border-radius: 0.5rem;">
                <strong>Calculated Total Cost Per Unit:</strong> 
                <span id="calculatedCostPerUnit" style="color: #6366f1; font-size: 1.2em;">₱0.00</span>
                <small style="display: block; color: #666; margin-top: 0.5rem;">
                    Formula: (Total Price + Shipping Admin Fee) ÷ Quantity
                </small>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeAddProductModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Product</button>
            </div>
        </form>
    </div>
</div>

<!-- Update Status Modal -->
<div id="statusModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeStatusModal()">&times;</span>
        <h3>Update Product Status</h3>
        <p><strong>Product:</strong> <span id="statusProductName"></span></p>
        <p><strong>Remaining Quantity:</strong> <span id="statusRemainingQty"></span></p>
        <form id="statusForm" onsubmit="updateStatus(event)">
            <input type="hidden" id="statusProductId" name="product_id">
            <div class="form-group">
                <label>Status *</label>
                <select id="statusSelect" name="status" required onchange="toggleFields()">
                    <option value="in_stock">In Stock</option>
                    <option value="used">Used</option>
                    <option value="freebie">Freebie</option>
                    <option value="raffled">Raffled</option>
                    <option value="sold">Sold</option>
                </select>
            </div>
            <div class="form-group" id="quantityUsedGroup" style="display: none;">
                <label>Quantity Used/Sold/Given *</label>
                <input type="number" id="quantityUsed" name="quantity_used" min="1" value="1" required>
                <small style="color: #666;">How many items are being marked as this status?</small>
            </div>
            <div class="form-group" id="sellingPriceGroup" style="display: none;">
                <label>Selling Price (₱) *</label>
                <input type="number" step="0.01" id="sellingPrice" name="selling_price">
            </div>
            <div class="form-group">
                <label>Remarks</label>
                <textarea name="remarks" rows="3"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeStatusModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Status</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.autocomplete-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 0.5rem 0.5rem;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.autocomplete-suggestion {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s;
}

.autocomplete-suggestion:hover {
    background-color: #f5f5f5;
}

.autocomplete-suggestion:last-child {
    border-bottom: none;
}

.autocomplete-suggestion.highlighted {
    background-color: #6366f1;
    color: white;
}

#productNameInput {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 0.5rem;
    font-size: 1rem;
}

#productNameInput:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}
</style>
<script>
// Store product names from server
const allProducts = {% if product_names %}{{ product_names|tojson }}{% else %}[]{% endif %}.filter(p => p && p.trim()); // Remove empty strings

let selectedProductIndex = -1;

function filterProducts() {
    const input = document.getElementById('productNameInput');
    const query = input.value.toLowerCase().trim();
    const suggestionsDiv = document.getElementById('productSuggestions');
    
    if (query.length === 0) {
        suggestionsDiv.innerHTML = '';
        suggestionsDiv.style.display = 'none';
        document.getElementById('productNameHidden').value = '';
        return;
    }
    
    // Filter products that match the query
    const matches = allProducts.filter(product => 
        product.toLowerCase().includes(query)
    );
    
    // Show at least first 7 matches (or all if less than 7)
    const displayMatches = matches.slice(0, Math.max(7, matches.length));
    
    if (displayMatches.length === 0) {
        suggestionsDiv.innerHTML = '<div class="autocomplete-suggestion" style="color: #999; cursor: default;">No products found</div>';
        suggestionsDiv.style.display = 'block';
        document.getElementById('productNameHidden').value = '';
        return;
    }
    
    // Build suggestions HTML
    let html = '';
    displayMatches.forEach((product, index) => {
        const highlighted = product.replace(
            new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi'),
            '<strong>$1</strong>'
        );
        // Escape quotes for HTML attribute (only " needs escaping in HTML attributes)
        const escapedProduct = product.replace(/"/g, '&quot;');
        html += `<div class="autocomplete-suggestion" data-index="${index}" data-product="${escapedProduct}" onclick="selectProductFromData(this)">${highlighted}</div>`;
    });
    
    suggestionsDiv.innerHTML = html;
    suggestionsDiv.style.display = 'block';
    selectedProductIndex = -1;
}

function selectProduct(productName) {
    document.getElementById('productNameInput').value = productName;
    document.getElementById('productNameHidden').value = productName;
    document.getElementById('productSuggestions').style.display = 'none';
    selectedProductIndex = -1;
}

function selectProductFromData(element) {
    const productName = element.getAttribute('data-product');
    selectProduct(productName);
}

function showProductSuggestions() {
    const input = document.getElementById('productNameInput');
    if (input.value.trim().length > 0) {
        filterProducts();
    } else {
        // Show all products when focused and empty
        const suggestionsDiv = document.getElementById('productSuggestions');
        let html = '';
        const displayProducts = allProducts.slice(0, 7);
        displayProducts.forEach(product => {
            // Escape quotes for HTML attribute
            const escapedProduct = product.replace(/"/g, '&quot;');
            html += `<div class="autocomplete-suggestion" data-product="${escapedProduct}" onclick="selectProductFromData(this)">${product}</div>`;
        });
        suggestionsDiv.innerHTML = html;
        suggestionsDiv.style.display = 'block';
    }
}

function hideProductSuggestions() {
    // Delay hiding to allow click events to fire
    setTimeout(() => {
        document.getElementById('productSuggestions').style.display = 'none';
    }, 200);
}

// Handle keyboard navigation
document.addEventListener('DOMContentLoaded', function() {
    const productInput = document.getElementById('productNameInput');
    if (productInput) {
        productInput.addEventListener('keydown', function(e) {
            const suggestions = document.querySelectorAll('.autocomplete-suggestion');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedProductIndex = Math.min(selectedProductIndex + 1, suggestions.length - 1);
                updateHighlight(suggestions);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedProductIndex = Math.max(selectedProductIndex - 1, -1);
                updateHighlight(suggestions);
            } else if (e.key === 'Enter' && selectedProductIndex >= 0) {
                e.preventDefault();
                const selected = suggestions[selectedProductIndex];
                if (selected && selected.dataset.product) {
                    selectProduct(selected.dataset.product);
                }
            } else if (e.key === 'Escape') {
                document.getElementById('productSuggestions').style.display = 'none';
                selectedProductIndex = -1;
            }
        });
    }
});

function updateHighlight(suggestions) {
    suggestions.forEach((suggestion, index) => {
        if (index === selectedProductIndex) {
            suggestion.classList.add('highlighted');
        } else {
            suggestion.classList.remove('highlighted');
        }
    });
}

function openAddProductModal() {
    document.getElementById('addProductModal').style.display = 'block';
    // Reset product input
    document.getElementById('productNameInput').value = '';
    document.getElementById('productNameHidden').value = '';
    document.getElementById('productSuggestions').style.display = 'none';
}

function closeAddProductModal() {
    document.getElementById('addProductModal').style.display = 'none';
    document.getElementById('addProductForm').reset();
    // Reset autocomplete fields
    document.getElementById('productNameInput').value = '';
    document.getElementById('productNameHidden').value = '';
    document.getElementById('productSuggestions').style.display = 'none';
    selectedProductIndex = -1;
}

function openStatusModal(index, productName, currentStatus, remainingQty) {
    document.getElementById('statusProductId').value = index;
    document.getElementById('statusProductName').textContent = productName;
    document.getElementById('statusRemainingQty').textContent = remainingQty;
    document.getElementById('statusSelect').value = currentStatus;
    document.getElementById('quantityUsed').max = remainingQty;
    document.getElementById('quantityUsed').value = Math.min(1, remainingQty);
    document.getElementById('statusModal').style.display = 'block';
    toggleFields();
}

function closeStatusModal() {
    document.getElementById('statusModal').style.display = 'none';
    document.getElementById('statusForm').reset();
}

function toggleFields() {
    const status = document.getElementById('statusSelect').value;
    const sellingPriceGroup = document.getElementById('sellingPriceGroup');
    const quantityUsedGroup = document.getElementById('quantityUsedGroup');
    const sellingPrice = document.getElementById('sellingPrice');
    
    // Show quantity field for sold, used, freebie
    if (status === 'sold' || status === 'used' || status === 'freebie') {
        quantityUsedGroup.style.display = 'block';
        document.getElementById('quantityUsed').required = true;
    } else {
        quantityUsedGroup.style.display = 'none';
        document.getElementById('quantityUsed').required = false;
    }
    
    // Show selling price only for sold
    if (status === 'sold') {
        sellingPriceGroup.style.display = 'block';
        sellingPrice.required = true;
    } else {
        sellingPriceGroup.style.display = 'none';
        sellingPrice.required = false;
    }
}

function calculateCostPerUnit() {
    const totalPrice = parseFloat(document.getElementById('totalPriceInput').value) || 0;
    const shippingAdminFee = parseFloat(document.getElementById('shippingAdminFeeInput').value) || 0;
    const quantity = parseFloat(document.getElementById('quantityInput').value) || 1;
    
    if (quantity > 0) {
        const costPerUnit = (totalPrice + shippingAdminFee) / quantity;
        document.getElementById('calculatedCostPerUnit').textContent = '₱' + costPerUnit.toFixed(2);
    } else {
        document.getElementById('calculatedCostPerUnit').textContent = '₱0.00';
    }
}

function addProduct(event) {
    event.preventDefault();
    
    // Validate that a product is selected
    const productName = document.getElementById('productNameHidden').value;
    if (!productName || productName.trim() === '') {
        alert('Please select a product from the list');
        document.getElementById('productNameInput').focus();
        return;
    }
    
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    
    // Ensure product_name is set from hidden field
    data.product_name = productName;
    
    fetch('/api/add_product', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Product added successfully!');
            location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

// Add event listeners for calculation
document.addEventListener('DOMContentLoaded', function() {
    const totalPriceInput = document.getElementById('totalPriceInput');
    const shippingAdminFeeInput = document.getElementById('shippingAdminFeeInput');
    const quantityInput = document.getElementById('quantityInput');
    
    if (totalPriceInput) {
        totalPriceInput.addEventListener('input', calculateCostPerUnit);
    }
    if (shippingAdminFeeInput) {
        shippingAdminFeeInput.addEventListener('input', calculateCostPerUnit);
    }
    if (quantityInput) {
        quantityInput.addEventListener('input', calculateCostPerUnit);
    }
});

function updateStatus(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    
    fetch('/api/update_status', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Status updated successfully!');
            location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

// Close modal when clicking outside
window.onclick = function(event) {
    const addModal = document.getElementById('addProductModal');
    const statusModal = document.getElementById('statusModal');
    if (event.target == addModal) {
        closeAddProductModal();
    }
    if (event.target == statusModal) {
        closeStatusModal();
    }
}
</script>
{% endblock %}


